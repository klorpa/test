;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;
;	Modification Data:
;
;	Edit	Date			Author					Reason
;	001		20xx/xx/xx		----					新規作成
;	002		2011/ 1/13		P						エラー対策
;	003		2011/ 4/25		P						仕様を大幅変更
;	004		2013/ 3/05		GunＰ					リストの最初のページと最後のページを行き来できるように加筆
;	005		2013/11/24		ひみつ					リスト表示数設定
;	006		2017/06/23		kuni					キャラ表示でINPUT_CHARA_LISTを使用するように変更
;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;予備キャラボタンを選択可能か＆名前表示
;@SHOPCOMABLE_180
;CALL SUB_TARGET_ABLE, 1
;RETURN RESULT

;@SHOPCOMABLE_181
;CALL SUB_TARGET_ABLE, 2
;RETURN RESULT

;@SHOPCOMABLE_182
;CALL SUB_TARGET_ABLE, 3
;RETURN RESULT

@SUB_TARGET_ABLE, ARG
CALL SHOPCOMABLE_108
LOCAL = FINDCHARA_ID(TARGET:ARG)
IF LOCAL >= 0
	;労役中キャラは除外
	SIF CFLAG:LOCAL:労役フラグ == 3
		TARGET:ARG = -1
	;妊娠育児中のキャラは除外
	SIF CHECK_CHILD_CARE(LOCAL) && FLAG:出産機能ONOFF == 1
		TARGET:ARG = -1
	;失踪中などこの場にいないなら除外
	SIF CFLAG:LOCAL:この場に居ないフラグ
		TARGET:ARG = -1
	SIF CFLAG:LOCAL:フィルタリングフラグ
		TARGET:ARG = -1
	LOCAL = TARGET:ARG ? LOCAL # -1
ENDIF
IF LOCAL == -1
	;---- EDIT 002 ADD START -------------------------
	;キャラがいなかった場合も、-1を代入
		TARGET:ARG = -1
	;---- EDIT 002 ADD END ---------------------------
	RESULTS = T{ARG}:EMPTY
ENDIF
RETURN RESULT

;予備キャラボタン選択時の動作
@SHOP_COM_511
CALL SUB_TARGET, 1
@SHOP_COM_512
CALL SUB_TARGET, 2
@SHOP_COM_513
CALL SUB_TARGET, 3
@SHOP_COM_514
CALL SUB_TARGET, 4
@SHOP_COM_515
CALL SUB_TARGET, 5
@SHOP_COM_516
CALL SUB_TARGET, 6
@SHOP_COM_517
CALL SUB_TARGET, 7
@SHOP_COM_518
CALL SUB_TARGET, 8
@SHOP_COM_519
CALL SUB_TARGET, 9

;EMPTYなら予備キャラ設定、設定済みならTARGETをそのキャラに変更
;現在のTARGETと同じキャラだったら解除
@SUB_TARGET, ARG
LOCAL = FINDCHARA_ID(TARGET:ARG)
IF LOCAL == -1
	CALL SUB_TARGET_SELECT, ARG
ELSE
	IF TARGET == LOCAL
		TARGET = -1
	ELSE
		TARGET = LOCAL
		SIF TARGET == ASSI
			ASSI = -1
		SIF FLAG:控え利用設定 == 1
			CALL SHOP_COM_100
	ENDIF
ENDIF

;@SUB_ASSI_ABLE, ARG
;CALL SHOPCOMABLE_109
;LOCAL = FINDCHARA_ID(ASSI:ARG)
;IF LOCAL >= 0
;	;労役中キャラは除外
;;	SIF CFLAG:LOCAL:労役フラグ == 3
		ASSI:ARG = -1
;;	;妊娠育児中のキャラは除外
;	SIF ((TALENT:LOCAL:妊娠 && CFLAG:LOCAL:出産予定日 - 2 <= DAY) || TALENT:LOCAL:育児中) && FLAG:出産機能ONOFF == 1
;		ASSI:ARG = -1
;	;失踪中などこの場にいないなら除外
;	SIF CFLAG:LOCAL:この場に居ないフラグ
;		ASSI:ARG = -1
;	SIF CFLAG:LOCAL:フィルタリングフラグ
;		ASSI:ARG = -1
;	SIF MARK:LOCAL:反発刻印 > 0
;		ASSI:ARG = -1
;	;助手可能でないものは除外
;	SIF CFLAG:LOCAL:売却可能 < 2
;		ASSI:ARG = -1
;	LOCAL = ASSI:ARG ? LOCAL # -1
;ENDIF
;IF LOCAL == -1
	;---- EDIT 002 ADD START -------------------------
;;	;キャラがいなかった場合も、-1を代入
;	ASSI:ARG = -1
;	;---- EDIT 002 ADD END ---------------------------
;	RESULTS = A{ARG}:EMPTY
;ELSE
;	SUBSTRING CALLNAME:LOCAL, 0, 16
;	RESULTS = A{ARG}:%RESULTS%
;ENDIF
;RETURN RESULT

;予備助手ボタン選択時の動作
@SHOP_COM_521
CALL SUB_ASSI, 1
@SHOP_COM_522
CALL SUB_ASSI, 2
@SHOP_COM_523
CALL SUB_ASSI, 3
@SHOP_COM_524
CALL SUB_ASSI, 4
@SHOP_COM_525
CALL SUB_ASSI, 5
@SHOP_COM_526
CALL SUB_ASSI, 6
@SHOP_COM_527
CALL SUB_ASSI, 7
@SHOP_COM_528
CALL SUB_ASSI, 8
@SHOP_COM_529
CALL SUB_ASSI, 9

;EMPTYなら予備助手設定、設定済みならASSIをその助手に変更
;現在のASSIと同じキャラだったら解除
@SUB_ASSI, ARG
LOCAL = FINDCHARA_ID(TARGET:ARG)
;---- EDIT 002 ADD START -------------------------
;条件を、ASSI:ARGからLOCALに
IF LOCAL == -1
;---- EDIT 002 ADD END ---------------------------
	CALL SUB_TARGET_SELECT, ARG
ELSE
	IF ASSI == LOCAL
		ASSI = -1
	ELSE
		IF !ISASSI:LOCAL
			PRINTFORML %CALLNAME:LOCAL% doesn't have any experience as an assistant.
			;は助手未経験です
			PRINTFORML Are you sure you want %HIM_HER(LOCAL)% to be the assistant?
			;本当に助手にしてもよろしいですか？
			CALL INPUT_YN, "Yes", "No"
			SIF RESULT
				RETURN 0
		ENDIF
		ASSI = LOCAL
		CALL ASSI_CHANGE
		;ISASSI:ASSI = 1
		IF ASSI == TARGET
			TARGET = -1
			FLAG:996 = -1
		ENDIF
	ENDIF
ENDIF

;ARG番目の予備助手を変更
;@SUB_ASSI_SELECT, ARG
;P = 0
;表示させるキャラを抽出（Q:*に表示するキャラの登録番号、LOCAL:2に人数）
;VARSET Q, 0
;A = 0
;FOR LOCAL, 0, CHARANUM
;	SIF MARK:LOCAL:反発刻印 > 0
;		CONTINUE
;	;主人は除外
;	SIF LOCAL == MASTER
;		CONTINUE
;	;労役中キャラは除外
;	SIF CFLAG:LOCAL:労役フラグ == 3
;		CONTINUE
;	;失踪中などこの場にいないなら除外
;	SIF CFLAG:LOCAL:この場に居ないフラグ
;		CONTINUE
;	;妊娠育児中のキャラは除外
;	SIF ((TALENT:LOCAL:妊娠 && CFLAG:LOCAL:出産予定日 - 2 <= DAY) || TALENT:LOCAL:育児中) && FLAG:出産機能ONOFF == 1
;		CONTINUE
;	;助手可能でないものは除外
;	SIF CFLAG:LOCAL:売却可能 < 2
;		CONTINUE
;	SIF CFLAG:LOCAL:フィルタリングフラグ
;		CONTINUE
;
;	Q:A = LOCAL
;	LOCAL:2 = A
;	A += 1
;NEXT

;$PRINT_LIST
;CALL ASSI_LIST
;DRAWLINE
;PRINTFORMLC \@(P <= 0) ? %" " * 16% # [1001]Previous page\@
;PRINTLC [1000]Return
;PRINTFORMLC \@(P >= (LOCAL:2 - 1) / 20) ? %" " * 16% # [1009]Next page\@

;$INPUT_LOOP
;INPUT
;IF RESULT == 1000
;	RETURN 0
;ELSEIF RESULT == 1001
;	IF P > 0
;		P -= 1
;		GOTO PRINT_LIST
;	ELSE
;		GOTO INPUT_LOOP
;	ENDIF
;ELSEIF RESULT == 1009
;	LOCAL = (LOCAL:2 - 1) / 20
;	IF P < LOCAL
;		P += 1
;		GOTO PRINT_LIST
;	ELSE
;		GOTO INPUT_LOOP
;	ENDIF
;ELSEIF RESULT == 0
;	ASSI:ARG = -1
;	RETURN 0
;ELSEIF RESULT < 0 || RESULT >= CHARANUM || MATCH(Q,RESULT,0) == 0
;	GOTO INPUT_LOOP
;ENDIF
;ASSI:ARG = CFLAG:RESULT:キャラ固有の番号

@SHOP_COM_531
CALL SUB_TARGET_SELECT, 1
@SHOP_COM_532
CALL SUB_TARGET_SELECT, 2
@SHOP_COM_533
CALL SUB_TARGET_SELECT, 3
@SHOP_COM_534
CALL SUB_TARGET_SELECT, 4
@SHOP_COM_535
CALL SUB_TARGET_SELECT, 5
@SHOP_COM_536
CALL SUB_TARGET_SELECT, 6
@SHOP_COM_537
CALL SUB_TARGET_SELECT, 7
@SHOP_COM_538
CALL SUB_TARGET_SELECT, 8
@SHOP_COM_539
CALL SUB_TARGET_SELECT, 9
;ARG番目の予備キャラを変更
@SUB_TARGET_SELECT, ARG
CALL INPUT_CHARA_LIST("Please specify an alternate training target", "CASTING_SUB_TARGET_SELECT", "", "", "MODECHANGE_SUB_TARGET_SELECT")
;解除する
IF RESULT == 1000
	RETURN 0
ELSEIF RESULT == 999
	TARGET:ARG = -1
ELSE
	TARGET:ARG = CFLAG:RESULT:キャラ固有の番号
ENDIF

@CASTING_SUB_TARGET_SELECT
;主人は除外
SIF COUNT == MASTER
	RETURN 0
;労役中キャラは除外
SIF CFLAG:COUNT:労役フラグ == 3
	RETURN 0
;妊娠育児中のキャラは除外
;SIF ((TALENT:COUNT:妊娠 && CFLAG:COUNT:出産予定日 - 2 <= DAY) || TALENT:COUNT:育児中) && FLAG:出産機能ONOFF == 1
;	RETURN 0
;失踪中などこの場にいないなら除外
SIF CFLAG:COUNT:この場に居ないフラグ
	RETURN 0
SIF CFLAG:COUNT:フィルタリングフラグ
	RETURN 0
RETURN 1

@MODECHANGE_SUB_TARGET_SELECT, ARG
SELECTCASE ARG
	CASE -1
		PRINTL 　[999]Remove from slot
	CASE 999
		RETURN ARG , 0
ENDSELECT
RETURN ARG , 1

;予備助手ボタンを選択可能か＆名前表示
;@SHOPCOMABLE_183
;CALL SUB_ASSI_ABLE, 1
;RETURN RESULT

;@SHOPCOMABLE_184
;CALL SUB_ASSI_ABLE, 2
;RETURN RESULT
;@SHOPCOMABLE_185
;CALL SHOPCOMABLE_108
;RESULTS = 予備変更
;RETURN RESULT


;@SHOP_COM_185
;SIF FINDCHARA_ID(TARGET:1) == -1
;	TARGET:1 = -1
;SIF FINDCHARA_ID(TARGET:2) == -1
;	TARGET:2 = -1
;SIF FINDCHARA_ID(TARGET:3) == -1
;	TARGET:3 = -1
;SIF FINDCHARA_ID(ASSI:1) == -1
;	ASSI:1 = -1
;SIF FINDCHARA_ID(ASSI:2) == -1
;	ASSI:2 = -1
;PRINTFORML [0] 予備調教対象1　\@TARGET:1 > 0 ? %CALLNAME:FINDCHARA_ID(TARGET:1)%# EMPTY\@
;PRINTFORML [1] 予備調教対象2　\@TARGET:2 > 0 ? %CALLNAME:FINDCHARA_ID(TARGET:2)%# EMPTY\@
;PRINTFORML [2] 予備調教対象3　\@TARGET:3 > 0 ? %CALLNAME:FINDCHARA_ID(TARGET:3)%# EMPTY\@
;CALL SHOPCOMABLE_109
;LOCAL = RESULT
;IF LOCAL
;	PRINTFORML [3] 予備助手1　\@ASSI:1 > 0 ? %CALLNAME:FINDCHARA_ID(ASSI:1)%# EMPTY\@
;	PRINTFORML [4] 予備助手2　\@ASSI:2 > 0 ? %CALLNAME:FINDCHARA_ID(ASSI:2)%# EMPTY\@
;ENDIF
;PRINTL [100] Return
;CALL INPUTINT(0, 1, 2 , LOCAL * 3, LOCAL * 4, 100)
;IF RESULT == 100
;	RETURN 0
;ELSEIF RESULT >= 3
;	CALL SUB_ASSI_SELECT, RESULT - 2
;ELSE
;	CALL SUB_TARGET_SELECT, RESULT + 1
;ENDIF
;RESTART
