
;=======================================================================
;サンプルダンジョン
;ダンジョンのテンプレートみたいなものです
;ダンジョンナンバー0
;=======================================================================




;=======================================================================
;攻略条件
;=======================================================================
@PREREQUISITE_DUNGEON_7
IF イベントフラグ:2:0 == 1 && ダンジョンフラグ:7:1 == 0
	RETURN 1
ELSE
	RETURN 0
ENDIF

;=======================================================================
;ダンジョン名
;=======================================================================
@GET_DUNGEON_NAME_7
RESULTS = Karukozaka Upper Area


;=======================================================================
;フロア名表示
;=======================================================================
@FLOORNAME_7
PRINT Karukozaka Upper Area
SELECTCASE FLAG:現M
	CASE 0
		PRINTL   ６Ｆ
	CASE 1
		PRINTL   ７Ｆ
	CASE 2
		PRINTL   ８Ｆ
	CASE 3
		PRINTL   ９Ｆ
	CASE 4
		PRINTL   １０Ｆ
	CASE 5
		PRINTL   １１Ｆ
	CASEELSE
		PRINTL
ENDSELECT


;=======================================================================
;特殊タイル表示
;=======================================================================
@TILE_MARK_7_X_X
RESULTS = 特


;=======================================================================
;スタート地点入力
;=======================================================================
@START_DUNGEON_7,ARG
FLAG:現M = 0
FLAG:現X = 11
FLAG:現Y = 13
;CALL AUTOMAP
FLAG:MAG消費率 = 75
@EVENT_DUNGEON_START_7
IF ダンジョンフラグ:7:0 == 0
	CALL SHOW_FLOOR
	CALL SHOW_NOW_FORMATION_P,0,2,,2
	FLAG:コマンド表示行数 = LINECOUNT
	CALL MESSAGE_WINDOW_D, "", "＞The upper levels of Karukozaka High School that fell into Makai/＞In here、Deity Emperor Hazama who caused this should be in here/＞……But、why are you here？/＞Even if there is a reward、those affected wouldn't be able to give much"
	CALL MESSAGE_WINDOW_D, "", @"＞Is it because he sent an assassin at you？/＞But、it is unlikly he would have many agents left that he could use outside of Karukozaka/＞Going forth on this trip that promised little money、%CALLNAME:MASTER% stepped forward"
	ダンジョンフラグ:7:0 = 1
ENDIF
;=======================================================================
;指定したマスに進入可能か
;=======================================================================
@CAN_ENTER_7,ARG,ARG:1
CALL CAN_ENTER,ARG,ARG:1
RETURN RESULT


;=======================================================================
;フロアデータ
;=======================================================================
@MAKE_FLOOR_7
SELECTCASE FLAG:現M
	CASE 0
	;１階
		FLAG:最大X = 17
		FLAG:最大Y = 17
		CALL MAKE_FLOOR_LINE, 0,"00000000000000000"
		CALL MAKE_FLOOR_LINE, 1,"01212121212121210"
		CALL MAKE_FLOOR_LINE, 2,"01000000020002020"
		CALL MAKE_FLOOR_LINE, 3,"01110121012101210"
		CALL MAKE_FLOOR_LINE, 4,"00020002000200020"
		CALL MAKE_FLOOR_LINE, 5,"01111101210101210"
		CALL MAKE_FLOOR_LINE, 6,"01111102020200020"
		CALL MAKE_FLOOR_LINE, 7,"01111101210101210"
		CALL MAKE_FLOOR_LINE, 8,"02020002000200000"
		CALL MAKE_FLOOR_LINE, 9,"01010601211111210"
		CALL MAKE_FLOOR_LINE,10,"01010201000000010"
		CALL MAKE_FLOOR_LINE,11,"01011101011111010"
		CALL MAKE_FLOOR_LINE,12,"00000001010201010"
		CALL MAKE_FLOOR_LINE,13,"01110001010801010"
		CALL MAKE_FLOOR_LINE,14,"00000000010001010"
		CALL MAKE_FLOOR_LINE,15,"01211111211111210"
		CALL MAKE_FLOOR_LINE,16,"00000000000000000"
		
	CASE 1
	;２階
		FLAG:最大X = 9
		FLAG:最大Y = 9
		CALL MAKE_FLOOR_LINE, 0,"000000000"
		CALL MAKE_FLOOR_LINE, 1,"011111110"
		CALL MAKE_FLOOR_LINE, 2,"010000010"
		CALL MAKE_FLOOR_LINE, 3,"010111010"
		CALL MAKE_FLOOR_LINE, 4,"010102010"
		CALL MAKE_FLOOR_LINE, 5,"010106010"
		CALL MAKE_FLOOR_LINE, 6,"020100010"
		CALL MAKE_FLOOR_LINE, 7,"070111110"
		CALL MAKE_FLOOR_LINE, 8,"000000000"

	CASE 2
	;３階
		FLAG:最大X = 9
		FLAG:最大Y = 9
		CALL MAKE_FLOOR_LINE, 0,"000000000"
		CALL MAKE_FLOOR_LINE, 1,"011111110"
		CALL MAKE_FLOOR_LINE, 2,"010000010"
		CALL MAKE_FLOOR_LINE, 3,"010111210"
		CALL MAKE_FLOOR_LINE, 4,"010200020"
		CALL MAKE_FLOOR_LINE, 5,"010607010"
		CALL MAKE_FLOOR_LINE, 6,"010002000"
		CALL MAKE_FLOOR_LINE, 7,"011111110"
		CALL MAKE_FLOOR_LINE, 8,"000000000"

	CASE 3
	;４階
		FLAG:最大X = 9
		FLAG:最大Y = 9
		CALL MAKE_FLOOR_LINE, 0,"000000000"
		CALL MAKE_FLOOR_LINE, 1,"011111110"
		CALL MAKE_FLOOR_LINE, 2,"010000010"
		CALL MAKE_FLOOR_LINE, 3,"010621010"
		CALL MAKE_FLOOR_LINE, 4,"010001010"
		CALL MAKE_FLOOR_LINE, 5,"010701010"
		CALL MAKE_FLOOR_LINE, 6,"010202010"
		CALL MAKE_FLOOR_LINE, 7,"011101110"
		CALL MAKE_FLOOR_LINE, 8,"000000000"

	CASE 4
	;５階
		FLAG:最大X = 7
		FLAG:最大Y = 9
		CALL MAKE_FLOOR_LINE, 0,"0000000"
		CALL MAKE_FLOOR_LINE, 1,"0111110"
		CALL MAKE_FLOOR_LINE, 2,"0100010"
		CALL MAKE_FLOOR_LINE, 3,"0127010"
		CALL MAKE_FLOOR_LINE, 4,"0000010"
		CALL MAKE_FLOOR_LINE, 5,"0106010"
		CALL MAKE_FLOOR_LINE, 6,"0102010"
		CALL MAKE_FLOOR_LINE, 7,"0111110"
		CALL MAKE_FLOOR_LINE, 8,"0000000"


	CASE 5
	;６階
		FLAG:最大X = 7
		FLAG:最大Y = 9
		CALL MAKE_FLOOR_LINE, 0,"0000000"
		CALL MAKE_FLOOR_LINE, 1,"0111110"
		CALL MAKE_FLOOR_LINE, 2,"0102010"
		CALL MAKE_FLOOR_LINE, 3,"0101010"
		CALL MAKE_FLOOR_LINE, 4,"0100010"
		CALL MAKE_FLOOR_LINE, 5,"0111110"
		CALL MAKE_FLOOR_LINE, 6,"0002000"
		CALL MAKE_FLOOR_LINE, 7,"0007000"
		CALL MAKE_FLOOR_LINE, 8,"0000000"
		;イベントの設置
		CALL SET_TILE,3,3,ダンジョンフラグ:7:1,0,4

	CASEELSE

ENDSELECT



;=======================================================================
;[5]調べる　実行時のイベント
;=======================================================================
@EVENT_CHECK_DUNGEON_7

;==========
;出口の処理
;==========
IF DA:(FLAG:現X):(FLAG:現Y) == 8
	CALL DUNGEON_EXIT
	RETURN 1
;=======
;階段
;=======
ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 6
	SELECTCASE FLAG:現M
		CASE 0
			SIF FLAG:現X == 5 && FLAG:現Y == 9
				CALL DUNGEON_UPSTAIRS,1,1,7
		CASE 1
			SIF FLAG:現X == 5 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,2,5,5
		CASE 2
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,3,3,5
		CASE 3
			SIF FLAG:現X == 3 && FLAG:現Y == 3
				CALL DUNGEON_UPSTAIRS,4,3,3
		CASE 4
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,5,3,7
		CASEELSE
	ENDSELECT

RETURN 1

ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 7
	SELECTCASE FLAG:現M
		CASE 1
			SIF FLAG:現X == 1 && FLAG:現Y == 7
				CALL DUNGEON_DOWNSTAIRS,0,5,9
		CASE 2
			SIF FLAG:現X == 5 && FLAG:現Y == 5
				CALL DUNGEON_DOWNSTAIRS,1,5,5
		CASE 3
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_DOWNSTAIRS,2,3,5
		CASE 4
			SIF FLAG:現X == 3 && FLAG:現Y == 3
				CALL DUNGEON_DOWNSTAIRS,3,3,3
		CASE 5
			SIF FLAG:現X == 3 && FLAG:現Y == 7
				CALL DUNGEON_DOWNSTAIRS,4,3,5
		CASEELSE
ENDSELECT

RETURN 1

ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 9
	CALL DUNGEON_TERMINAL
	RETURN 1
ELSE
	CALL MESSAGE_WINDOW_D, "", "＞Nothing seems to be here."
	RETURN 0
ENDIF

;=======================================================================
;タイル進入時のイベント
;=======================================================================
@EVENT_ENTER_DUNGEON_7,ARG
;ARG = 進入時の向き　0の場合ワープなど
;==========
;出口の処理
;==========
IF DA:(FLAG:現X):(FLAG:現Y) == 8
	CALL DUNGEON_EXIT
	RETURN 1

;=======
;階段
;=======
ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 6
	SELECTCASE FLAG:現M
		CASE 0
			SIF FLAG:現X == 5 && FLAG:現Y == 9
				CALL DUNGEON_UPSTAIRS,1,1,7
		CASE 1
			SIF FLAG:現X == 5 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,2,5,5
		CASE 2
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,3,3,5
		CASE 3
			SIF FLAG:現X == 3 && FLAG:現Y == 3
				CALL DUNGEON_UPSTAIRS,4,3,3
		CASE 4
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_UPSTAIRS,5,3,7
		CASEELSE
	ENDSELECT

RETURN 1

ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 7
	SELECTCASE FLAG:現M
		CASE 1
			SIF FLAG:現X == 1 && FLAG:現Y == 7
				CALL DUNGEON_DOWNSTAIRS,0,5,9
		CASE 2
			SIF FLAG:現X == 5 && FLAG:現Y == 5
				CALL DUNGEON_DOWNSTAIRS,1,5,5
		CASE 3
			SIF FLAG:現X == 3 && FLAG:現Y == 5
				CALL DUNGEON_DOWNSTAIRS,2,3,5
		CASE 4
			SIF FLAG:現X == 3 && FLAG:現Y == 3
				CALL DUNGEON_DOWNSTAIRS,3,3,3
		CASE 5
			SIF FLAG:現X == 3 && FLAG:現Y == 7
				CALL DUNGEON_DOWNSTAIRS,4,3,5
		CASEELSE
ENDSELECT
RETURN 1
;==========
;扉の処理
;==========
ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 2
	CALL DUNGEON_DOOR,ARG
RETURN 1

ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 9
	CALL DUNGEON_TERMINAL
RETURN 1

;========================
;イベント
;========================
ELSEIF DA:(FLAG:現X):(FLAG:現Y) == 4
	IF ダンジョンフラグ:7:1 == 0 && FLAG:現M == 5
		CALL SHOW_FLOOR
		CALL SHOW_NOW_FORMATION_P,0,2,,2
		FLAG:コマンド表示行数 = LINECOUNT
		CALL MESSAGE_WINDOW_D, "", "＞Reaching the top、you saw a boy standing there/＞In the room、there were no decorations"
		CALL MESSAGE_WINDOW_D, "Hazama", "……Welcome、uninvited guest/I really want to entertain you、but you can see there is nothing here/Because I only put significant things here"
		CALL MESSAGE_WINDOW_D, "Hazama", "……In other words I need nothing/Everything is waste、garbage！/It natural for it to vanish！！"
		CALL MESSAGE_WINDOW_D, "", "＞Meta Hazama appeared！"
		FLAG:逃走不可フラグ = 1
		FLAG:会話不能フラグ = 1
		FLAG:先制不意打ちキャンセル = 1
		CALL SET_ENEMY,9,4202,80,0,1
		CFLAG:(CHARANUM-1):ＨＰ補正 = 5000
		CALL SYNC_STATUS,(CHARANUM-1)
		CALL HEALTH_CHARA,(CHARANUM-1)
		CFLAG:(CHARANUM-1):行動回数 = 2
		CALL BATTLE_START
		FLAG:逃走不可フラグ = 0
		FLAG:会話不能フラグ = 0
		FLAG:先制不意打ちキャンセル = 0
		CALL MESSAGE_WINDOW_D, "Hazama", "Impossible……"
		IF FINDCHARA_B(4508) == 2 && ダンジョンフラグ:43:0 == 1
			CALL MESSAGE_WINDOW_D, "", "＞From the huge form of Deity Emperor Hazama、he changed back into an ordinary high-school boy and surrendered/＞The case of Karukozaka High School falling into Makai seems to be solved with this/＞From the parents of the surviving students、you got ￥50000"
			MONEY += 50000
			CALL MESSAGE_WINDOW_D, "", "＞“Ring of Deliverance” obtained/＞The ring of deliverance began to shine/＞You could now enter Hazama's Inner World！"
			FLAG:脱出 = 1
		ELSE
			CALL MESSAGE_WINDOW_D, "", "＞From the huge form of Deity Emperor Hazama、he changed back into an ordinary high-school boy and surrendered/＞The case of Karukozaka High School falling into Makai seems to be solved with this/＞From the parents of the surviving students、you got ￥50000"
			MONEY += 50000
		ENDIF
		ダンジョンフラグ:7:1 = 1
		DA:(FLAG:現X):(FLAG:現Y) = 1
		;FLAG:脱出 = 1
	ENDIF
ENDIF

RETURN 0



;=======================================================================
;エンカウント率
;=======================================================================
@ENCOUNT_RATE_7
		FLAG:エンカウント率 = FLAG:未遭遇歩数*5
SIF FLAG:未遭遇歩数 < 6
	FLAG:エンカウント率 = 0
;=======================================================================
;必要レベル目安
;推奨LV 雑魚最低LV 雑魚最高LV ボスLV 
;=======================================================================
@GET_DUNGEON_LV_7
RETURN 41, 38, 56, 80
;=======================================================================
;エンカウント処理
;=======================================================================
@CHECK_ENCOUNT_7
IF RAND:100 < FLAG:エンカウント率
	CALL ENEMY_TABLE
	RETURN 1
ELSE
	FLAG:未遭遇歩数 += 1
	RETURN 0
ENDIF
;=======================================================================
;敵の種族の種類数
;=======================================================================
@CLASS_NUM_7
RETURN CLASS_NUM_COMMON("最上級")
;=======================================================================
;敵の総数
;ARGは出現する敵の種類です
;RAND(X, Y)はX〜Y-1のうちのどれかになるRANDです
;なお、ここで帰った数字は下限を種族数、上限を10として自動的に調整されます
;=======================================================================
@ENEMY_NUM_7, ARG
RETURN ENEMY_NUM_COMMON("最上級", ARG)
;=======================================================================
;敵の種類
;=======================================================================
@ENEMY_7, ARG
SELECTCASE FLAG:現M
	CASE 0
		SELECTCASE RAND:100
			CASE IS < 20
				;20%でタマモ
				RETURN 807, 38
			CASE IS < 40
				;20%でオトヒメ
				RETURN 706, 42
			CASE IS < 60
				;20%でヴィヴィアン
				RETURN 509, 42
			CASE IS < 80
				;20%　邪龍バジリスクLV25(41)
				RETURN [[キャラ:バジリスク]], 41
			CASE IS < 100
				;20%でマッハ
				RETURN 907, 42
		ENDSELECT

	CASE 1
		SELECTCASE RAND:100
			CASE IS < 20
				;25%でヴィヴィアン
				RETURN 509, 45
			CASE IS < 40
				;25%でマッハ
				RETURN 907, 45
			CASE IS < 60
				;25%でスキュラ
				RETURN 808, 43
			CASE IS < 80
				;20%　邪龍バジリスクLV25(44)
				RETURN [[キャラ:バジリスク]], 44
			CASE IS < 100
				;25%でサキュバス
				RETURN 407, 44
		ENDSELECT
	CASE 2
		SELECTCASE RAND:100
			CASE IS < 25
				;25%でスキュラ
				RETURN 808, 46
			CASE IS < 50
				;25%でサキュバス
				RETURN 407, 47
			CASE IS < 75
				;15%でダッキ
				RETURN 811, 47
			CASE IS < 100
				;15%でダーキニー
				RETURN 607, 46
		ENDSELECT
	CASE 3
		SELECTCASE RAND:100
			CASE IS < 25
				;25%でダッキ
				RETURN 811, 50
			CASE IS < 50
				;25%でダーキニー
				RETURN 607, 49
			CASE IS < 75
				;75%でアールマティ
				RETURN 306, 48
			CASE IS < 100
				;100%でモーリアン
				RETURN 908, 49
		ENDSELECT
	CASE 4
		SELECTCASE RAND:100
			CASE IS < 25
				;25%でアールマティ
				RETURN 306, 51
			CASE IS < 50
				;25%でモーリアン
				RETURN 908, 52
			CASE IS < 75
				;75%でバステト
				RETURN 809, 51
			CASE IS < 100
				;100%でランダ
				RETURN 206, 50
		ENDSELECT
	CASE 5
		SELECTCASE RAND:100
			CASE IS < 25
				;25%でバステト
				RETURN 809, 54
			CASE IS < 50
				;25%でランダ
				RETURN 206, 53
			CASE IS < 75
				;75%でティターニア
				RETURN 510, 51
			CASE IS < 100
				;100%でヴァルキリー
				RETURN 408, 56
		ENDSELECT
ENDSELECT
